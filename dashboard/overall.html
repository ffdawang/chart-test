<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>仓位历史管控台 - 全景</title>

<link href="css/style.css" rel="stylesheet" type="text/css">
<link href="css/font-awesome.css" rel="stylesheet" type="text/css">
<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/dygraph-combined.js"></script>
<script src="js/data.js"></script>
<script src="js/jquery.mloading.js"></script>
</head>

<script>
    var numOfStorage = 15;

    var g_graph = null;

    var g_data = new Array(numOfStorage);


    function clearPicture(o) {
        o.find('img').each(function(i, item) {
            $(item).attr('src','');
        });
    }

    function createGraph(data) {
        var graph_div = document.getElementById('chart_div');
        var xline = document.createElement('div');
        xline.className = 'line xline';
        xline.style.top = '0px';
        g = new Dygraph(
            graph_div,
            data, 
            {
                drawGrid:false,
                axes: {
                    y: {
                        drawAxis: false,
                        drawGrid: false
                    },
                    x: {
                        axisLabelFormatter: function(d, gran) {
                            return Dygraph.zeropad(d.getHours()) + ':' + Dygraph.zeropad(d.getMinutes());
                        }
                    }
                },
                pixelsPerLabel:50,
                xAxisHeight:0,
                xRangePad:40,
                highlightCallback: function(e, x, pts) {
                    xline.style.left = pts[0].canvasx + 'px';
                    xline.style.visibility = 'visible';
                },
                unhighlightCallback: function(e) {
                    xline.style.visibility = 'hidden';
                },
                clickCallback: function(e, x, point ) {
                    updateOnClick(new Date(x), g_data);
                }
            } 
        );
        $(graph_div).children('div')[0].appendChild(xline);
        return g;
    }

    function updateOnClick(t, data) {
        var flags = new Array(data.length);
        for( i=0; i<data.length; i++ ) {
            nd = data[i];
            var last = null;
            var target = null;
            while( nd != null ) {
                if( nd.time >= t ) {
                    if( nd.time == t ) target = nd;
                    else target = last ? last : nd;
                    break;
                }
                last = nd;
                nd = nd.next; 
            }
            if( !target ) target = last;
            updateInfo(target, i, flags);
        }
    }

    function updateInfo(nd, idx, flags) {
        if( !nd || !nd.jsonurl ) {
            $('div.wh-list').eq(idx).hide();
            return;
        }
        if( $('div.wh-list').eq(idx).is(':hidden') )
            $('div.wh-list').eq(idx).show();
        var o = $('button.wh-sum').eq(idx);
        o.find('.wh-no:first').text(idx+1);
        o.find('span:first').removeClass();
        if( nd.status == 1 ) { 
            o.find('span:first').addClass('wh-normal');
        } else {
            o.find('span:first').addClass('wh-alarm');
        }
        o.find('span:first').text(nd.text);
        o.find('.wh-detail:first').empty();
        o.find('.wh-detail:first').append('重量: '+nd.weight+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;体积: ' + nd.volume + ' M3');
        $.ajax({
            type:'GET',
            url:nd.jsonurl,
            obj: o,
            success:function(data) {
                var len = data.shape.videoPic.length;
                imgs = this.obj.next().find('div.images-b').eq(0);
                clearPicture(imgs)
                scanimg = imgs.next();
                clearPicture(scanimg)
                for(i=0;i<len;i++) {
                    if( i >= 4 ) break;
                    imgs.find('img').eq(i).attr('src', data.shape.videoPic[i].url);
                }
                scanimg.find('img').eq(0).attr('src', data.shape.shapePic[0].url);
            }
        });
    }


    function loadData(dl, data) {
        var d = new Date();
        var s =(d.getYear()+1900)+''+ (d.getMonth()+1<10?'0'+(d.getMonth()+1):(d.getMonth()+1)) + '' + (d.getDate()<10?'0'+d.getDate():d.getDate()); 

        var flags = new Array(numOfStorage);
        for( sid=1; sid<=numOfStorage; sid++) {
            $.ajax({
                type:'GET',
                url: 'http://d.wsncm.com/311/' + sid + '/index' + s + '.txt',
                storage: sid,
                success: function(txt) {
                    dl[this.storage-1] = DataList.create();
                    dl[this.storage-1].load(txt);
                } 
            }).always(function() {
                flags[this.storage-1] = 1;
                for( i=0; i<numOfStorage; i++ ) {
                    if( !flags[i] ) return;
                }
                prepareData(dl, data);
                presentData(dl, data);
            });
        }
    }

    function prepareData(dl, data) {
        var now = new Date();
        var d = new Date(now.getYear()+1900, now.getMonth(), now.getDate(), 0, 0, 0);
        for( i=0; i<numOfStorage; i++ ) {
            if( dl[i] ) data[i] = dl[i].since(d);
        } 
    }

    function latestUpdateTime(dl) {
        var m = new Date(1900,1,1,0,0,0);
        for( i=0; i<dl.length; i++ ) {
            if( dl[i] && dl[i].tail.time > m ) m = dl[i].tail.time;
        }
        return m;
    }

    function presentData(dl, data) {
        var latest = latestUpdateTime(dl);
        timeline = [];
        now = new Date;
        var d = new Date(now.getYear()+1900, now.getMonth(), now.getDate(), 0, 0, 0);
        while( d < latest ) {
            timeline.push([d,0]);
            d = d.addMins(1);
        }
        g_graph = createGraph(timeline); 
    }

    function createDOMNodes() {
        o = $('div.main').eq(0);
        for( i=0; i<numOfStorage; i++ ) {
            item = $('<div class="wh-list"> <button class="wh-sum"> <div class="wh-no"></div> <div class="wh-status"><span class="wh-normal"></span></div> <div class="wh-detail"></div> </button> <div class="wh-img" style="display:none"> <div class="images-b"><img src=""><img src=""><img src=""> <img src=""> </div> <div class="scan-image-b"> <img src=""> </div> <div class="clear"> </div> </div> </div>');    
            item.hide();
            o.append(item);
        }
        btns = $('button.wh-sum');
        for( i=0;i<numOfStorage;i++) {
            o = btns.eq(i);
            o.on('click', {value:i, obj:o}, function(e){
                e.data.obj.next().toggle(300);
            });
        }
    }

    $(document).ready(function(){
        if( g_graph ) g_graph.destroy();
        var dl = new Array(numOfStorage);
        loadData(dl, g_data);
        createDOMNodes();
    });
</script>

<body>
<div class="banner">
	<div class="logo">
    	<img src="images/logo.png">
    </div>
    <div class="menu">
    <a href="index.html">仓位</a>
    </div>
    <div class="menu menu-active">
    全景
    </div>
    <div class="menu">
    <span style="text-decoration: underline">仓库</span>：无锡中储十号库
    </div>
    <div class="clear">
    </div>
</div>

<div class="timeline-line">
</div>
    
<div class="timeline">
    <div class="line-chart" id="chart_div">
    </div>
</div>
    
<div class="timeline-line">
</div>

<div class="main">


</div>

</body>
</html>
